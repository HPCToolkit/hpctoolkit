<?xml version="1.0" encoding="UTF-8"?>
<!-- -*- coding: utf-8 -*- -->

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	  "http://www.w3.org/TR/html4/loose.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <!-- meta http-equiv="Content-Type" content="text/html; charset=utf-8" -->
  <link rel="stylesheet" type="text/css" href="style/style.css" />

  <title>Current Spack Issues for HPCToolkit</title>
</head>

<body>

<!-- HPCToolkit Image (height = 71 pixels) -->
<img style="position: absolute; top: 0px; left: 0px" src="style/header.gif" alt="hpctoolkit" />
<div style="position: relative; margin-top: 60px; width: 100%; text-align: right;">
<p style="margin: 0px; font-size: small;">
  [ <a href="index.html">Home</a>
    | <a href="overview.html">Overview</a>
    | <a href="publications.html">Publications</a>
    | <a href="software.html">Software/Downloads</a> ]
  &bull;
  [ <a href="documentation.html">Documentation/Questions</a>
    | <a href="training.html">Training Videos and Slides</a> ]
  &bull;
  [ <a href="info-people.html">People</a>
    | <a href="info-acks.html">Acks</a> ]
</p>
</div>
<div style="width: 100%;">
  <hr />
</div>

<h1 class="settitle" align="center">Current Spack Issues for HPCToolkit</h1>


<a name="SEC_Contents"></a>
<h2 class="contents-heading">Table of Contents</h2>

<div class="contents">
<ul class="no-bullet">
<li><a name="toc-Introduction" href="#Introduction">1 Introduction</a></li>
<li><a name="toc-Current-Issues" href="#Current-Issues">2 Current Issues</a>
<ul class="no-bullet">
  <li><a name="toc-_00282021_002d07_002d11_0029-Dyninst-cannot-find-Libiberty-libraries" href="#g_t_00282021_002d07_002d11_0029-Dyninst-cannot-find-Libiberty-libraries">2.1 (2021-07-11) Dyninst cannot find Libiberty libraries</a></li>
  <li><a name="toc-_00282021_002d07_002d11_0029-HPCToolkit-build-fails-in-hpcrun_002dfmt_002eh" href="#g_t_00282021_002d07_002d11_0029-HPCToolkit-build-fails-in-hpcrun_002dfmt_002eh">2.2 (2021-07-11) HPCToolkit build fails in hpcrun-fmt.h</a></li>
</ul></li>
<li><a name="toc-Recently-Resolved-Issues" href="#Recently-Resolved-Issues">3 Recently Resolved Issues</a>
<ul class="no-bullet">
  <li><a name="toc-_00282020_002d09_002d05_0029-Configure-fails-without-_002dfPIC-in-dependencies" href="#g_t_00282020_002d09_002d05_0029-Configure-fails-without-_002dfPIC-in-dependencies">3.1 (2020-09-05) Configure fails without -fPIC in dependencies</a></li>
  <li><a name="toc-_00282020_002d06_002d29_0029-Cray-front_002dend-compilers" href="#g_t_00282020_002d06_002d29_0029-Cray-front_002dend-compilers">3.2 (2020-06-29) Cray front-end compilers</a></li>
</ul></li>
<li><a name="toc-General-Problems" href="#General-Problems">4 General Problems</a>
<ul class="no-bullet">
  <li><a name="toc-Unable-to-fetch" href="#Unable-to-fetch">4.1 Unable to fetch</a></li>
  <li><a name="toc-Connection-timeout" href="#Connection-timeout">4.2 Connection timeout</a></li>
  <li><a name="toc-New-version-breaks-the-build" href="#New-version-breaks-the-build">4.3 New version breaks the build</a></li>
  <li><a name="toc-Spack-core-breaks-the-build" href="#Spack-core-breaks-the-build">4.4 Spack core breaks the build</a></li>
  <li><a name="toc-IBM_002dJava-fails-to-fetch-_0028powerpc_0029" href="#IBM_002dJava-fails-to-fetch-_0028powerpc_0029">4.5 IBM-Java fails to fetch (powerpc)</a></li>
</ul></li>
<li><a name="toc-Issues-with-specific-versions" href="#Issues-with-specific-versions">5 Issues with specific versions</a>
<ul class="no-bullet">
  <li><a name="toc-Binutils-2_002e35" href="#Binutils-2_002e35">5.1 Binutils 2.35</a></li>
  <li><a name="toc-Boost-1_002e68_002e0" href="#Boost-1_002e68_002e0">5.2 Boost 1.68.0</a></li>
  <li><a name="toc-Elfutils-0_002e176" href="#Elfutils-0_002e176">5.3 Elfutils 0.176</a></li>
</ul></li>

</ul>
</div>



<a name="Introduction"></a>
<h3 class="section">1 Introduction</h3>

<p>Spack is a moving target and receives multiple commits per day.
Normally, HPCToolkit will build and run successfully with the latest
version of all of its prerequisite packages, but sometimes not.  This
page covers the current known issues where HPCToolkit fails to build
with the latest version of spack.  The main build directions are at:
</p>
<p><a href="software-instructions.html">software-instructions.html</a>
</p>
<p>Report problems to <code>hpctoolkit-forum at rice dot edu</code>.  But before
reporting a problem, first try the versions recommended in the
<code>packages.yaml</code> file in the <code>spack</code> subdirectory of the
hpctoolkit repository.  And always check the latest version of this file
on the hpctoolkit web site.
</p>
<div class="example">
<pre class="example"><a href="http://hpctoolkit.org/spack-issues.html">http://hpctoolkit.org/spack-issues.html</a>
</pre></div>

<p>Last revised: July 11, 2021.
</p>

<a name="Current-Issues"></a>
<h3 class="section">2 Current Issues</h3>

<a name="g_t_00282021_002d07_002d11_0029-Dyninst-cannot-find-Libiberty-libraries"></a>
<h4 class="subsection">2.1 (2021-07-11) Dyninst cannot find Libiberty libraries</h4>

<p>Rarely, on some systems, dyninst cmake is unable to find the libiberty
libraries and fails with a message similar to the following.
</p>
<div class="example">
<pre class="example">-- Could NOT find LibIberty (missing: LibIberty_LIBRARIES) 
CMake Error at cmake/LibIberty.cmake:53 (message):
  LibIberty not found and cannot be downloaded because build is sterile.
Call Stack (most recent call first):
  CMakeLists.txt:34 (include)
</pre></div>

<p>This problem is infrequent and not well understood.  It seems to happen
more often on some Debian or Ubuntu systems, but certainly not all such
systems.  So, if you run into this problem and can reproduce it, please
report this to <code>hpctoolkit-forum</code> as above.
</p>
<p><b>Workaround:</b> Apply the following patch to the spack repository, or
just hand-edit the dyninst <code>package.py</code> file to add the one line.
(Note: the last context line in the patch is a blank line.)
</p>
<div class="example">
<pre class="example">diff --git a/var/spack/repos/builtin/packages/dyninst/package.py b/var/spack/repos/builtin/packages/dyninst/package.py
index 38c664d500..0b71d332a8 100644
--- a/var/spack/repos/builtin/packages/dyninst/package.py
+++ b/var/spack/repos/builtin/packages/dyninst/package.py
@@ -103,6 +103,7 @@ def cmake_args(self):
             '-DBoost_ROOT_DIR=%s'     % spec['boost'].prefix,
             '-DElfUtils_ROOT_DIR=%s'  % spec['elf'].prefix,
             '-DLibIberty_ROOT_DIR=%s' % spec['libiberty'].prefix,
+            '-DLibIberty_LIBRARIES=%s' % spec['libiberty'].libs,
             '-DTBB_ROOT_DIR=%s'       % spec['tbb'].prefix,
         ]

</pre></div>


<a name="g_t_00282021_002d07_002d11_0029-HPCToolkit-build-fails-in-hpcrun_002dfmt_002eh"></a>
<h4 class="subsection">2.2 (2021-07-11) HPCToolkit build fails in hpcrun-fmt.h</h4>

<p>Very rarely, the hpctoolkit build fails in <code>hpcrun-fmt.c</code> or
<code>hpcrun-fmt.h</code> with a spew of messages similar to the following.
</p>
<div class="example">
<pre class="example">In file included from hpcrun-fmt.c:84:
hpcrun-fmt.h:1:1: error: expected identifier or '(' before string constant
 &quot;$Id$\n&quot;
 ^~~~~~~~
hpcrun-fmt.c: In function 'hpcrun_fmt_hdr_fwrite':
hpcrun-fmt.c:131:10: error: 'HPCRUN_FMT_Magic' undeclared (first use in this function)
   fwrite(HPCRUN_FMT_Magic,   1, HPCRUN_FMT_MagicLen, fs);
</pre></div>

<p>The problem is that <code>git clone</code> resulted in a corrupted copy of
<code>hpcrun-fmt.h</code>.  This file should be a C/C++ header file beginning
with a copyright notice in comments.
</p>
<div class="example">
<pre class="example">// -*-Mode: C++;-*- // technically C99

// * BeginRiceCopyright *****************************************************
//
// $HeadURL$
// $Id$
//
...
</pre></div>

<p>The corrupted copy is the same as <code>hpcrun-fmt.txt</code> except that
every line begins and ends with double quotes.
</p>
<div class="example">
<pre class="example">&quot;$Id$\n&quot;
&quot;\n&quot;
&quot;=============================================================================\n&quot;
&quot;hpcrun binary data format (see &quot;Abbreviation notes&quot; below)\n&quot;
&quot;=============================================================================\n&quot;
&quot;\n&quot;
&quot;fmt-hdr {epoch}*\n&quot;
&quot;  \n&quot;
...
</pre></div>

<p>This problem is rare, non-deterministic, not at all understood, and
impossible to reproduce on demand.  So again, if you can reproduce the
problem, even non-deterministically, please report this as above.
</p>
<p><b>Workaround:</b> The only workaround is to retry the git clone.  If
building outside of spack, the delete the source tree and repeat git
clone.  If building with spack, first remove spack&rsquo;s downloaded copy
with <code>spack clean -d</code>, then retry <code>spack install</code>.
</p>

<a name="Recently-Resolved-Issues"></a>
<h3 class="section">3 Recently Resolved Issues</h3>

<a name="g_t_00282020_002d09_002d05_0029-Configure-fails-without-_002dfPIC-in-dependencies"></a>
<h4 class="subsection">3.1 (2020-09-05) Configure fails without -fPIC in dependencies</h4>

<p>As of commit <a href="https://github.com/HPCToolkit/hpctoolkit/pull/317">b2d3d067ecad</a> on 2020-09-05, the hpctoolkit master branch now requires
libunwind and xz (lzma) to be built with variant <code>+pic</code>.  This is
used to better separate and hide third-party libraries in hpcrun from
the application.  If not, then configure will fail with an error such
as:
</p>
<div class="example">
<pre class="example">configure: libunwind.a static archive: yes
configure: libunwind.a compiled with -fPIC: no
configure: error: libunwind.a must be compiled with -fPIC
</pre></div>

<p><b>Fixed:</b> Build libunwind and xz (lzma) with the <code>+pic</code> variants.
For example, in <code>packages.yaml</code>,
</p>
<div class="example">
<pre class="example">libunwind:
  version:  [1.5.0]
  variants: +xz +pic
xz:
  version:  [5.2.5]
  variants: +pic
</pre></div>


<a name="g_t_00282020_002d06_002d29_0029-Cray-front_002dend-compilers"></a>
<h4 class="subsection">3.2 (2020-06-29) Cray front-end compilers</h4>

<p><code>Spack compiler find</code> was previously broken for detecting the
front-end compilers on Cray that HPCToolkit uses.
</p>
<p><b>Fixed:</b> This is now fixed in commit
<a href="https://github.com/spack/spack/pull/17267">789d060ff61b</a>
on 2020-06-29.
</p>
<p><b>Note:</b> Remember, you still need to fill in the <code>modules:</code>
field with the following four modules.  For example, this is an entry
for the <code>gcc/8.3.0</code> module on theta at ANL.  Note that the
front-end operating_system is something like <code>sles15</code> (not
<code>cnl6</code>), and the front-end target is <code>x86_64</code> (not
<code>mic_knl</code>).  Your versions may differ.
</p>
<div class="example">
<pre class="example">- compiler:
    environment: {}
    flags: {}
    modules:
    - PrgEnv-gnu/6.0.7
    - gcc/8.3.0
    - craype/2.6.5
    - cray-mpich/7.7.14
    operating_system: sles15
    paths:
      cc:  /opt/gcc/8.3.0/bin/gcc
      cxx: /opt/gcc/8.3.0/bin/g++
      f77: /opt/gcc/8.3.0/bin/gfortran
      fc:  /opt/gcc/8.3.0/bin/gfortran
    spec: gcc@8.3.0
    target: x86_64
</pre></div>


<a name="General-Problems"></a>
<h3 class="section">4 General Problems</h3>

<p>These are general problems that arise from time to time.
</p>
<a name="Unable-to-fetch"></a>
<h4 class="subsection">4.1 Unable to fetch</h4>

<p>Sometimes spack fails to download the source file(s) for some package
and dies with a message similar to this.
</p>
<div class="example">
<pre class="example">==&gt; Fetching from https://ftpmirror.gnu.org/m4/m4-1.4.18.tar.gz failed.
==&gt; Error: FetchError: All fetchers failed for m4-1.4.18-vorbvkcjfac43b7vuswsvnm6xe7w7or5
</pre></div>

<p>This problem is usually temporary and the solution is to either wait a
few minutes or an hour and try again, or else download the file manually
and put it into a spack mirror.
</p>
<a name="Connection-timeout"></a>
<h4 class="subsection">4.2 Connection timeout</h4>

<p>Another way fetch can fail is with a connection timeout.  Some sites,
especially sourceforge are often slow to connect.  If this happens, then
increase the connection timeout in <code>config.yaml</code> to 30 or 60
seconds (default is 10 seconds).
</p>
<a name="New-version-breaks-the-build"></a>
<h4 class="subsection">4.3 New version breaks the build</h4>

<p>Sometimes the latest version of some package breaks the build.  This has
happened a couple of times where a new version of Boost has broken the
build for Dyninst.  The solution is to revert the package to an earlier
version until the rest of the code catches up.
</p>
<a name="Spack-core-breaks-the-build"></a>
<h4 class="subsection">4.4 Spack core breaks the build</h4>

<p>Sometimes but rarely, something in the spack core will change or break
the code in some <code>package.py</code> file.  The solution is to look
through the spack git log and revert the repository to a recent commit
before the breakage.
</p>

<a name="IBM_002dJava-fails-to-fetch-_0028powerpc_0029"></a>
<h4 class="subsection">4.5 IBM-Java fails to fetch (powerpc)</h4>

<p>IBM is fairly aggressive about taking down old versions, so you may find
that fetching ibm-java fails while trying to install hpcviewer (powerpc
only).
</p>
<div class="example">
<pre class="example">==&gt; Installing ibm-java
==&gt; No binary for ibm-java found: installing from source
==&gt; Error: FetchError: All fetchers failed
</pre></div>

<p>If this happens, first compare <code>spack info ibm-java</code> with what
versions are available at IBM&rsquo;s download site.  If there is another
8.0.x.y version that spack understands that is still available for
download, then use that.
</p>
<div class="example">
<pre class="example"><a href="http://public.dhe.ibm.com/ibmdl/export/pub/systems/cloud/runtimes/java">http://public.dhe.ibm.com/ibmdl/export/pub/systems/cloud/runtimes/java</a>
</pre></div>

<p>If not, then manually download the latest 8.0.x.y version, compute a
<code>sha256sum</code> checksum for the file and then edit the
<code>ibm-java/package.py</code> file to add this version.  And then report
the problem to the spack maintainer.
</p>

<a name="Issues-with-specific-versions"></a>
<h3 class="section">5 Issues with specific versions</h3>

<a name="Binutils-2_002e35"></a>
<h4 class="subsection">5.1 Binutils 2.35</h4>

<p>Avoid binutils versions 2.35 and 2.35.1, they contain a bug that causes
hpcprof to spew BFD Dwarf errors about &ldquo;could not find variable
specification at offset xxxx.&rdquo;  This is fixed in release 2.35.2 or 2.36
or later.
</p>
<a name="Boost-1_002e68_002e0"></a>
<h4 class="subsection">5.2 Boost 1.68.0</h4>

<p>Avoid boost version 1.68.0, it breaks the build for hpctoolkit.
</p>
<a name="Elfutils-0_002e176"></a>
<h4 class="subsection">5.3 Elfutils 0.176</h4>

<p>Beginning with 0.176, elfutils requires glibc 2.16 or later and won&rsquo;t
work with an older glibc, including RedHat or CentOS 6.x and Blue Gene.
</p>
<hr>



<div style="width: 100%; font-size: small;">
  <hr />
  <p style="margin: 0px; font-size: small;">
    &copy;2000-2021 <a href="http://www.rice.edu">Rice University</a>
    &bull;
    <a href="http://www.cs.rice.edu">Rice Computer Science</a>
  </p>
  <a href="http://validator.w3.org/check/referer">
    <img src="http://www.w3.org/Icons/valid-xhtml10-blue" alt="" height="15" /></a>
  <a href="http://jigsaw.w3.org/css-validator/check/referer">
    <img src="http://www.w3.org/Icons/valid-css-blue" alt="" height="15" /></a>
</div>

</body>
</html>
