#!/bin/sh

############################################################################################
#
# hpcslink: a wrapper script for linking performance instrumentation into a 
#           statically-linked executable 
#
#           modification history 
#           --------------------
#           2007 08 04 - John Mellor-Crummey - created
#
############################################################################################

#----------------------------------------------------------------------------------
# this command
#----------------------------------------------------------------------------------
THISCMD=$0
THISCMDBASE=`basename $THISCMD`
THISCMDDIR=`dirname $THISCMD`
ROOTDIR=`dirname $THISCMDDIR`

#----------------------------------------------------------------------------------
# determine if usage information should be reported 
#----------------------------------------------------------------------------------
USAGE=
if test "x$1" = x; then
  USAGE=1
fi
if test "x$1" = x--help; then
  USAGE=1
fi

#----------------------------------------------------------------------------------
# turn on debugging by setting VERBOSE to non-empty value
#----------------------------------------------------------------------------------
VERBOSE=
if test "x$1" = x-v; then
  VERBOSE=1
  shift
fi

#----------------------------------------------------------------------------------
# path for helper directory
#----------------------------------------------------------------------------------
LPATH=$ROOTDIR/libexec

#----------------------------------------------------------------------------------
# set up path to use static wrappers
#----------------------------------------------------------------------------------
export PATH=$LPATH:$PATH 

#----------------------------------------------------------------------------------
# grab the command being used to link the executable
#----------------------------------------------------------------------------------
LINKCMD=$1

if test "x$LINKCMD" != x; then
  LINKCMDBASE=`basename $LINKCMD`
else
  USAGE=1
fi

#----------------------------------------------------------------------------------
# echo usage information, if necessary
#----------------------------------------------------------------------------------
if test "x$USAGE" = x1; then
  echo Usage: "$THISCMDBASE [options] link command"
  echo Options:
  echo "    -v         display the programs called by the script" 
  echo "    --help     print the options for $THISCMDBASE"
  exit -1
fi

#----------------------------------------------------------------------------------
# peel the link command off the command line
#----------------------------------------------------------------------------------
shift

export HPC_LINK_CONFIG="$ROOTDIR/lib/$THISCMDBASE/catamount/libs.conf"

#----------------------------------------------------------------------------------
# for the PGI and GNU programming environment, specify the linker appropriately
#----------------------------------------------------------------------------------
EXTRA_ARG=
case $PE_ENV in

  GNU) EXTRA_ARG=-B$LPATH
	;;
  PGI) EXTRA_ARG=-Yl,$LPATH
	;;

esac

#----------------------------------------------------------------------------------
# debugging support to echo command if -v option given
#----------------------------------------------------------------------------------
if test "x$VERBOSE" != x; then
  echo $LINKCMD $EXTRA_ARG $*
  export HPC_LINK_VERBOSE=yes
fi

#----------------------------------------------------------------------------------
# execute the command using our linker, which will add hpctoolkit's instrumentation
#----------------------------------------------------------------------------------
exec $LINKCMD $EXTRA_ARG $*
